<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Expression Fuzzer &#8212; Velox  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css?v=0f882399" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Aggregation and Window Fuzzer" href="fuzzer.html" />
    <link rel="prev" title="Cache Fuzzer" href="cache-fuzzer.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="fuzzer.html" title="Aggregation and Window Fuzzer"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cache-fuzzer.html" title="Cache Fuzzer"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Velox  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../develop.html" >Developer Guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../testing.html" accesskey="U">Testing Tools</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Expression Fuzzer</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="expression-fuzzer">
<h1>Expression Fuzzer<a class="headerlink" href="#expression-fuzzer" title="Link to this heading">¶</a></h1>
<p>Velox allows users to define UDFs (user-defined functions) and provides an
Expression Fuzzer tool to test the engine and UDFs thoroughly. This tool is
being used to test builtin Presto and Spark functions and have discovered
numerous bugs caused by corner cases that are difficult to cover in unit tests.</p>
<p>The Expression Fuzzer tests the expression evaluation engine and UDFs by
generating random expressions and evaluating these on random input vectors.
Each generated expression may contain multiple sub-expressions and each input
vector can have random and potentially nested encodings.</p>
<p>To ensure that evaluation engine and UDFs handle vector encodings correctly, the
expression fuzzer evaluates each expression twice and asserts the results to be
the same: using regular evaluation path and using simplified evaluation that
flattens all input vectors before evaluating an expression.</p>
<section id="how-to-integrate">
<h2>How to integrate<a class="headerlink" href="#how-to-integrate" title="Link to this heading">¶</a></h2>
<p>To integrate with the Expression Fuzzer, create a test, register all scalar
functions supported by the engine, and call <code class="docutils literal notranslate"><span class="pre">FuzzerRunner::run()</span></code> defined in
<a class="reference external" href="https://github.com/facebookincubator/velox/blob/main/velox/expression/fuzzer/ExpressionFuzzer.h">FuzzerRunner.h</a>. See <a class="reference external" href="https://github.com/facebookincubator/velox/blob/main/velox/expression/fuzzer/ExpressionFuzzerTest.cpp">ExpressionFuzzerTest.cpp</a>.</p>
<p>Functions with known bugs can be excluded from testing using a skip-list.</p>
</section>
<section id="custom-input-generators">
<h2>Custom Input Generators<a class="headerlink" href="#custom-input-generators" title="Link to this heading">¶</a></h2>
<p>Custom input generators for expression fuzzer are needed when:</p>
<ul class="simple">
<li><p>A function requires input values to satisfy specific constraints (e.g., valid JSON or URL).</p></li>
<li><p>The default random input generation does not provide sufficient coverage of edge cases.</p></li>
</ul>
<p>A custom input generator can be defined with the following steps.</p>
<section id="step-1-define-the-generator-class">
<h3>Step 1: Define the generator class<a class="headerlink" href="#step-1-define-the-generator-class" title="Link to this heading">¶</a></h3>
<p>The developer can implement a custom input generator class by
inheriting from <code class="docutils literal notranslate"><span class="pre">ArgValuesGenerator</span></code> and overriding the <code class="docutils literal notranslate"><span class="pre">generate()</span></code>
method. An example is the <a class="reference external" href="https://github.com/facebookincubator/velox/blob/d25685bb6fddb76e467ee740d221455b1fac8f96/velox/expression/fuzzer/ArgValuesGenerators.h#L22">JsonParseArgValuesGenerator</a> class.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JsonParseArgValuesGenerator</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ArgValuesGenerator</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="o">~</span><span class="n">JsonParseArgValuesGenerator</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">TypedExprPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">generate</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">CallableSignature</span><span class="o">&amp;</span><span class="w"> </span><span class="n">signature</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VectorFuzzer</span><span class="o">::</span><span class="n">Options</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">,</span>
<span class="w">    </span><span class="n">FuzzerGenerator</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rng</span><span class="p">,</span>
<span class="w">    </span><span class="n">ExpressionFuzzerState</span><span class="o">&amp;</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="step-2-implement-the-generate-method">
<h3>Step 2: Implement the generate() method<a class="headerlink" href="#step-2-implement-the-generate-method" title="Link to this heading">¶</a></h3>
<p>When implementing the <code class="docutils literal notranslate"><span class="pre">generate()</span></code> method, the developer first call
<code class="docutils literal notranslate"><span class="pre">populateInputTypesAndNames(signature,</span> <span class="pre">state)</span></code> to append argument types
of <code class="docutils literal notranslate"><span class="pre">signature</span></code> and the corresponding input column names to <code class="docutils literal notranslate"><span class="pre">state</span></code>.
Next, for every argument of <code class="docutils literal notranslate"><span class="pre">signature</span></code> in order, if it requires a custom
input generator, the developer emplace back an std::shared_ptr of a subclass
of <code class="docutils literal notranslate"><span class="pre">AbstractInputGenerator</span></code> into <code class="docutils literal notranslate"><span class="pre">state.customInputGenerators_</span></code>. The
developer also emplace back a <code class="docutils literal notranslate"><span class="pre">FieldAccessTypedExprPtr</span></code> created with this
argument type and the corresponding input column name into <code class="docutils literal notranslate"><span class="pre">inputExpressions</span></code>.
Every subclass of <code class="docutils literal notranslate"><span class="pre">AbstractInputGenerator</span></code> allows generating input values
satisfying certain constraint. E.g., <code class="docutils literal notranslate"><span class="pre">RangeConstrainedGenerator</span></code> allows
generating values in a specified range; <code class="docutils literal notranslate"><span class="pre">JsonInputGenerator</span></code> allows generating
valid JSON strings that represent a specified data type.</p>
<p>If the argument doesn’t require a custom input generator, the developer emplace
a nullptr back into both <code class="docutils literal notranslate"><span class="pre">state.customInputGenerators_</span></code> and <code class="docutils literal notranslate"><span class="pre">inputExpressions</span></code>.
Finally, this <code class="docutils literal notranslate"><span class="pre">generate()</span></code> method returns <code class="docutils literal notranslate"><span class="pre">inputExpressions</span></code>.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">TypedExprPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">JsonParseArgValuesGenerator</span><span class="o">::</span><span class="n">generate</span><span class="p">(</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">CallableSignature</span><span class="o">&amp;</span><span class="w"> </span><span class="n">signature</span><span class="p">,</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">VectorFuzzer</span><span class="o">::</span><span class="n">Options</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">,</span>
<span class="w">  </span><span class="n">FuzzerGenerator</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rng</span><span class="p">,</span>
<span class="w">  </span><span class="n">ExpressionFuzzerState</span><span class="o">&amp;</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">VELOX_CHECK_EQ</span><span class="p">(</span><span class="n">signature</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">populateInputTypesAndNames</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">representedType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">facebook</span><span class="o">::</span><span class="n">velox</span><span class="o">::</span><span class="n">randType</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rng</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">nullRatio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">nullRatio</span><span class="p">;</span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">customInputGenerators_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">fuzzer</span><span class="o">::</span><span class="n">JsonInputGenerator</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">        </span><span class="n">seed</span><span class="p">,</span>
<span class="w">        </span><span class="n">signature</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="w">        </span><span class="n">nullRatio</span><span class="p">,</span>
<span class="w">        </span><span class="n">fuzzer</span><span class="o">::</span><span class="n">getRandomInputGenerator</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="n">representedType</span><span class="p">,</span><span class="w"> </span><span class="n">nullRatio</span><span class="p">),</span>
<span class="w">        </span><span class="nb">true</span><span class="p">));</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">TypedExprPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">inputExpressions</span><span class="p">{</span>
<span class="w">    </span><span class="n">signature</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="k">nullptr</span><span class="p">};</span>
<span class="w">  </span><span class="n">inputExpressions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">FieldAccessTypedExpr</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">signature</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">inputRowNames_</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">inputExpressions</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="step-3-register-the-custom-input-generator">
<h3>Step 3: Register the custom input generator<a class="headerlink" href="#step-3-register-the-custom-input-generator" title="Link to this heading">¶</a></h3>
<p>Once the custom input generator is implemented, the developer register it in
the <code class="docutils literal notranslate"><span class="pre">main</span></code> function in ExpressionFuzzerTest.cpp as follows.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ArgValuesGenerator</span><span class="o">&gt;&gt;</span>
<span class="w">  </span><span class="n">argValuesGenerators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">{</span><span class="s">&quot;json_parse&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">JsonParseArgValuesGenerator</span><span class="o">&gt;</span><span class="p">()},</span>
<span class="w">      </span><span class="p">{</span><span class="s">&quot;function_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">CustomInputGeneratorClassName</span><span class="o">&gt;</span><span class="p">()},</span>
<span class="w">      </span><span class="p">...};</span>
</pre></div>
</div>
</section>
</section>
<section id="how-to-run">
<h2>How to run<a class="headerlink" href="#how-to-run" title="Link to this heading">¶</a></h2>
<p>Expression Fuzzer supports a number of powerful command line arguments.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">–-steps</span></code>: How many iterations to run. Each iteration generates and evaluates one expression or aggregation. Default is 10.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">–-duration_sec</span></code>: For how long to run in seconds. If both <code class="docutils literal notranslate"><span class="pre">-–steps</span></code> and <code class="docutils literal notranslate"><span class="pre">-–duration_sec</span></code> are specified, –duration_sec takes precedence.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">–-seed</span></code>: The seed to generate random expressions and input vectors with.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">–-v=1</span></code>: Verbose logging (from <a class="reference external" href="https://github.com/google/glog#setting-flags">Google Logging Library</a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">–-only</span></code>: A comma-separated list of functions to use in generated expressions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">–-batch_size</span></code>: The size of input vectors to generate. Default is 100.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--null_ratio</span></code>: Chance of adding a null constant to the plan, or null value in a vector (expressed as double from 0 to 1). Default is 0.1.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--max_num_varargs</span></code>: The maximum number of variadic arguments fuzzer will generate for functions that accept variadic arguments. Fuzzer will generate up to max_num_varargs arguments for the variadic list in addition to the required arguments by the function. Default is 10.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--retry_with_try</span></code>: Retry failed expressions by wrapping it using a try() statement. Default is false.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--enable_variadic_signatures</span></code>: Enable testing of function signatures with variadic arguments. Default is false.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--special_forms</span></code>: Enable testing of specified special forms, including <cite>and</cite>, <cite>or</cite>, <cite>cast</cite>, <cite>coalesce</cite>, <cite>if</cite>, and <cite>switch</cite>. Every fuzzer test specifies the enabled special forms of its own. velox_expression_fuzzer_test has all the aforementioned special forms enabled by default.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--enable_dereference</span></code>: Enable testing of the field-reference from structs and row_constructor functions. Default is false.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--velox_fuzzer_enable_complex_types</span></code>: Enable testing of function signatures with complex argument or return types. Default is false.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--velox_fuzzer_enable_decimal_type</span></code>: Enable testing of function signatures with decimal argument or return type. Default is false.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--lazy_vector_generation_ratio</span></code>: Specifies the probability with which columns in the input row vector will be selected to be wrapped in lazy encoding (expressed as double from 0 to 1). Default is 0.0.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--velox_fuzzer_enable_column_reuse</span></code>: Enable generation of expressions where one input column can be used by multiple subexpressions. Default is false.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--velox_fuzzer_enable_expression_reuse</span></code>: Enable generation of expressions that re-uses already generated subexpressions. Default is false.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--assign_function_tickets</span></code>: Comma separated list of function names and their tickets in the format &lt;function_name&gt;=&lt;tickets&gt;. Every ticket represents an opportunity for a function to be chosen from a pool of candidates. By default, every function has one ticket, and the likelihood of a function being picked can be increased by allotting it more tickets. Note that in practice, increasing the number of tickets does not proportionally increase the likelihood of selection, as the selection process involves filtering the pool of candidates by a required return type so not all functions may compete against the same number of functions at every instance. Number of tickets must be a positive integer. Example: eq=3,floor=5.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--max_expression_trees_per_step</span></code>: This sets an upper limit on the number of expression trees to generate per step. These trees would be executed in the same ExprSet and can re-use already generated columns and subexpressions (if re-use is enabled). Default is 1.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--velox_fuzzer_max_level_of_nesting</span></code>: Max levels of expression nesting. Default is 10 and minimum is 1.</p></li>
</ul>
<p>If you would like to run Expression Fuzzer with Presto as the source of truth, two command line arguments can be used to specify the url and timeout of Presto:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--presto_url</span></code>: Presto coordinator URI along with port.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--req_timeout_ms</span></code>: Timeout in milliseconds for HTTP requests made to the reference DB, such as Presto.</p></li>
</ul>
<p>If running from CLion IDE, add <code class="docutils literal notranslate"><span class="pre">--logtostderr=1</span></code> to see the full output.</p>
<p>An example set of arguments to run the expression fuzzer with all features enabled is as follows:
<code class="docutils literal notranslate"><span class="pre">--duration_sec</span> <span class="pre">60</span>
<span class="pre">--enable_variadic_signatures</span>
<span class="pre">--lazy_vector_generation_ratio</span> <span class="pre">0.2</span>
<span class="pre">--velox_fuzzer_enable_complex_types</span>
<span class="pre">--velox_fuzzer_enable_expression_reuse</span>
<span class="pre">--velox_fuzzer_enable_column_reuse</span>
<span class="pre">--retry_with_try</span>
<span class="pre">--enable_dereference</span>
<span class="pre">--special_forms=&quot;and,or,cast,coalesce,if,switch&quot;</span>
<span class="pre">--max_expression_trees_per_step=2</span>
<span class="pre">--repro_persist_path=&lt;a_valid_local_path&gt;</span>
<span class="pre">--logtostderr=1</span></code></p>
<p>Expression fuzzer with Presto as the source of truth currently only supports a subset of features:
<code class="docutils literal notranslate"><span class="pre">--duration_sec</span> <span class="pre">60</span>
<span class="pre">--presto_url=http://127.0.0.1:8080</span>
<span class="pre">--req_timeout_ms</span> <span class="pre">10000</span>
<span class="pre">--enable_variadic_signatures</span>
<span class="pre">--velox_fuzzer_enable_complex_types</span>
<span class="pre">--special_forms=&quot;cast,coalesce,if,switch&quot;</span>
<span class="pre">--lazy_vector_generation_ratio</span> <span class="pre">0.2</span>
<span class="pre">--velox_fuzzer_enable_column_reuse</span>
<span class="pre">--velox_fuzzer_enable_expression_reuse</span>
<span class="pre">--max_expression_trees_per_step</span> <span class="pre">2</span>
<span class="pre">--logtostderr=1</span></code></p>
</section>
<section id="how-to-reproduce-failures">
<h2>How to reproduce failures<a class="headerlink" href="#how-to-reproduce-failures" title="Link to this heading">¶</a></h2>
<p>When Fuzzer test fails, a seed number and the evaluated expression are
printed to the log. An example is given below. Developers can use <code class="docutils literal notranslate"><span class="pre">--seed</span></code>
with this seed number to rerun the exact same expression with the same inputs,
and use a debugger to investigate the issue. For the example below, the command
to reproduce the error would be <code class="docutils literal notranslate"><span class="pre">velox/expression/fuzzer/velox_expression_fuzzer_test</span> <span class="pre">--seed</span> <span class="pre">1188545576</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">I0819</span> <span class="mi">18</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mf">52.249965</span> <span class="mi">1954756</span> <span class="n">ExpressionFuzzer</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">685</span><span class="p">]</span> <span class="o">==============================&gt;</span> <span class="n">Started</span> <span class="n">iteration</span> <span class="mi">38</span>
<span class="p">(</span><span class="n">seed</span><span class="p">:</span> <span class="mi">1188545576</span><span class="p">)</span>
<span class="n">I0819</span> <span class="mi">18</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mf">52.250263</span> <span class="mi">1954756</span> <span class="n">ExpressionFuzzer</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">578</span><span class="p">]</span>
<span class="n">Executing</span> <span class="n">expression</span><span class="p">:</span> <span class="ow">in</span><span class="p">(</span><span class="s2">&quot;c0&quot;</span><span class="p">,</span><span class="mi">10</span> <span class="n">elements</span> <span class="n">starting</span> <span class="n">at</span> <span class="mi">0</span> <span class="p">{</span><span class="mi">120</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="o">-</span><span class="mi">71</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="o">...</span><span class="p">})</span>
<span class="n">I0819</span> <span class="mi">18</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mf">52.250350</span> <span class="mi">1954756</span> <span class="n">ExpressionFuzzer</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">581</span><span class="p">]</span> <span class="mi">1</span> <span class="n">vectors</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
<span class="n">I0819</span> <span class="mi">18</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mf">52.250401</span> <span class="mi">1954756</span> <span class="n">ExpressionFuzzer</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">583</span><span class="p">]</span>     <span class="p">[</span><span class="n">FLAT</span> <span class="n">TINYINT</span><span class="p">:</span> <span class="mi">100</span> <span class="n">elements</span><span class="p">,</span> <span class="mi">6</span> <span class="n">nulls</span><span class="p">]</span>
<span class="n">E0819</span> <span class="mi">18</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mf">52.252044</span> <span class="mi">1954756</span> <span class="n">Exceptions</span><span class="o">.</span><span class="n">h</span><span class="p">:</span><span class="mi">68</span><span class="p">]</span> <span class="n">Line</span><span class="p">:</span> <span class="n">velox</span><span class="o">/</span><span class="n">expression</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">ExpressionFuzzer</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">153</span><span class="p">,</span> <span class="n">Function</span><span class="p">:</span><span class="n">compareVectors</span><span class="p">,</span> <span class="n">Expression</span><span class="p">:</span> <span class="n">vec1</span><span class="o">-&gt;</span><span class="n">equalValueAt</span><span class="p">(</span><span class="n">vec2</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="n">Different</span> <span class="n">results</span> <span class="n">at</span> <span class="n">idx</span> <span class="s1">&#39;78&#39;</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span> <span class="n">vs</span><span class="o">.</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">Source</span><span class="p">:</span> <span class="n">RUNTIME</span><span class="p">,</span> <span class="n">ErrorCode</span><span class="p">:</span> <span class="n">INVALID_STATE</span>
<span class="n">terminate</span> <span class="n">called</span> <span class="n">after</span> <span class="n">throwing</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="s1">&#39;facebook::velox::VeloxRuntimeError&#39;</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Note that changes to the set of all UDFs to test with invalidates this
reproduction, which can be affected by the skip function list, the <code class="docutils literal notranslate"><span class="pre">--only</span></code>
argument, or the base commit, etc. This is because the chosen UDFs in the
expression are determined by both the seed and the pool of all UDFs to choose
from. So make sure you use the same configuration when reproducing a failure.</p>
</section>
<section id="accurate-on-disk-reproduction">
<h2>Accurate on-disk reproduction<a class="headerlink" href="#accurate-on-disk-reproduction" title="Link to this heading">¶</a></h2>
<p>Sometimes developers may want to capture an issue and investigate later,
possibly by someone else using a different machine. Using <code class="docutils literal notranslate"><span class="pre">--seed</span></code> is not
sufficient to accurately reproduce the failure in this scenario. This could be
cased by different behaviors of random generator on different platforms,
additions/removals of UDFs from the list, and etc. To have an accurate
reproduction of a fuzzer failure regardless of environments you can record the
input vector and expression to files and replay these later.</p>
<ol class="arabic simple">
<li><p>Run Fuzzer using <code class="docutils literal notranslate"><span class="pre">--seed</span></code> and <code class="docutils literal notranslate"><span class="pre">--repro_persist_path</span></code> flags to save the input vector and expression to files in the specified directory. Add “–persist_and_run_once” if the issue is not an exception failure but a crash failure.</p></li>
<li><p>Run Expression Runner using generated files.</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">--repro_persist_path</span> <span class="pre">&lt;path/to/directory&gt;</span></code> flag tells the Fuzzer to save the
input vector, initial result vector, expression SQL, and other relevant data to files in a new directory saved within
the specified directory. It also prints out the exact paths for these. Fuzzer uses <a class="reference internal" href="../debugging/vector-saver.html"><span class="doc">VectorSaver</span></a>
for storing vectors on disk while preserving encodings.</p>
<p>If an iteration crashes the process before data can be persisted, run the fuzzer
with the seed used for that iteration and use the following flag:</p>
<p><code class="docutils literal notranslate"><span class="pre">--persist_and_run_once</span></code> Persist repro info before evaluation and only run one iteration.
This is to rerun with the seed number and persist repro info upon a crash failure.
Only effective if repro_persist_path is set.</p>
<p>ExpressionRunner needs at the very least a path to input vector and path to expression SQL to run.
However, you might need more files to reproduce the issue. All of which will be present in the directory
that the fuzzer test generated. You can directly point the ExpressionRunner to that directory using –fuzzer_repro_path
where it will pick up all the files automatically or you can specify each explicitly using other startup flags.
ExpressionRunner supports the following flags:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">--fuzzer_repro_path</span></code> directory path where all input files (required to reproduce a failure) that are generated by the Fuzzer are expected to reside. ExpressionRunner will automatically pick up all the files from this folder unless they are explicitly specified via their respective startup flag.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--input_path</span></code> path to input vector that was created by the Fuzzer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--sql_path</span></code> path to expression SQL that was created by the Fuzzer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--registry</span></code> function registry to use for evaluating expression. One of “presto” (default) or “spark”.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--complex_constant_path</span></code> optional path to complex constants that aren’t accurately expressable in SQL (Array, Map, Structs, …). This is used with SQL file to reproduce the exact expression, not needed when the expression doesn’t contain complex constants.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--input_row_metadata_path</span></code> optional path for the file stored on-disk which contains a struct containing input row metadata. This includes columns in the input row vector to be wrapped in a lazy vector and/or dictionary encoded. It may also contain a dictionary peel for columns requiring dictionary encoding. This is used when the failing test included input columns that were lazy vectors and/or had columns wrapped with a common dictionary wrap.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--result_path</span></code> optional path to result vector that was created by the Fuzzer. Result vector is used to reproduce cases where Fuzzer passes dirty vectors to expression evaluation as a result buffer. This ensures that functions are implemented correctly, taking into consideration dirty result buffer.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--mode</span></code> run mode. One of “verify”, “common” (default), “simplified”.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">verify</span></code> evaluates the expression using common and simplified paths and compares the results. This is identical to a fuzzer run.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">common</span></code> evaluates the expression using common path and prints the results to stdout.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">simplified</span></code> evaluates the expression using simplified path and prints the results to stdout.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">query</span></code> evaluate SQL query specified in –sql or –sql_path and print out results. If –input_path is specified, the query may reference it as table ‘t’.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--num_rows</span></code> optional number of rows to process in common and simplified modes. Default: 10. 0 means all rows. This flag is ignored in ‘verify’ mode.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--store_result_path</span></code> optional directory path for storing the results of evaluating SQL expression or query in ‘common’, ‘simplified’ or ‘query’ modes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--findMinimalSubExpression</span></code> optional Whether to find minimum failing subexpression on result mismatch. Set to false by default.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--useSeperatePoolForInput</span></code> optional If true (default), expression evaluator and input vectors use different memory pools. This helps trigger code-paths that can depend on vectors having different pools. For eg, when copying a flat string vector copies of the strings stored in the string buffers need to be created. If however, the pools were the same between the vectors then the buffers can simply be shared between them instead.</p></li>
</ul>
<p>Example command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">velox</span><span class="o">/</span><span class="n">expression</span><span class="o">/</span><span class="n">tests</span><span class="p">:</span><span class="n">velox_expression_runner_test</span> <span class="o">--</span><span class="n">input_path</span> <span class="s2">&quot;/path/to/input&quot;</span> <span class="o">--</span><span class="n">sql_path</span> <span class="s2">&quot;/path/to/sql&quot;</span> <span class="o">--</span><span class="n">result_path</span> <span class="s2">&quot;/path/to/result&quot;</span>
</pre></div>
</div>
<p>To assist debugging workload, ExpressionRunner supports <code class="docutils literal notranslate"><span class="pre">--sql</span></code> to specify
SQL expression on the command line. <code class="docutils literal notranslate"><span class="pre">--sql</span></code> option can be used standalone to
evaluate constant expression or together with <code class="docutils literal notranslate"><span class="pre">--input_path</span></code> to evaluate
expression on a vector. <code class="docutils literal notranslate"><span class="pre">--sql</span></code> and <code class="docutils literal notranslate"><span class="pre">--sql_path</span></code> flags are mutually
exclusive. If both are specified, <code class="docutils literal notranslate"><span class="pre">--sql</span></code> is used while <code class="docutils literal notranslate"><span class="pre">--sql_path</span></code> is
ignored. <code class="docutils literal notranslate"><span class="pre">--sql</span></code> option allow to specify multiple comma-separated SQL
expressions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ velox/expression/tests:velox_expression_runner_test --sql &quot;pow(2, 3), ceil(1.3)&quot;

I1101 11:32:51.955689 2306506 ExpressionRunner.cpp:127] Evaluating SQL expression(s): pow(2, 3), ceil(1.3)
Result: ROW&lt;_col0:DOUBLE,_col1:DOUBLE&gt;
8 | 2

$ velox/expression/tests:velox_expression_runner_test --sql &quot;pow(2, 3)&quot;

Evaluating SQL expression(s): pow(2, 3)
Result: ROW&lt;_col0:DOUBLE&gt;
8

$ velox/expression/tests:velox_expression_runner_test --sql &quot;array_sort(array[3,6,1,null,2])&quot;
Building: finished in 0.3 sec (100%) 817/3213 jobs, 0/3213 updated

Evaluating SQL expression(s): array_sort(array[3,6,1,null,2])
Result: ROW&lt;_col0:ARRAY&lt;INTEGER&gt;&gt;
[1,2,3,6,null]

$ velox/expression/tests:velox_expression_runner_test --sql &quot;array_sort(array[3,6,1,null,2]), filter(array[1, 2, 3, 4], x -&gt; (x % 2 == 0))&quot;

Evaluating SQL expression(s): array_sort(array[3,6,1,null,2]), filter(array[1, 2, 3, 4], x -&gt; (x % 2 == 0))
Result: ROW&lt;_col0:ARRAY&lt;INTEGER&gt;,_col1:ARRAY&lt;INTEGER&gt;&gt;
[1,2,3,6,null] | [2,4]
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Expression Fuzzer</a><ul>
<li><a class="reference internal" href="#how-to-integrate">How to integrate</a></li>
<li><a class="reference internal" href="#custom-input-generators">Custom Input Generators</a><ul>
<li><a class="reference internal" href="#step-1-define-the-generator-class">Step 1: Define the generator class</a></li>
<li><a class="reference internal" href="#step-2-implement-the-generate-method">Step 2: Implement the generate() method</a></li>
<li><a class="reference internal" href="#step-3-register-the-custom-input-generator">Step 3: Register the custom input generator</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-run">How to run</a></li>
<li><a class="reference internal" href="#how-to-reproduce-failures">How to reproduce failures</a></li>
<li><a class="reference internal" href="#accurate-on-disk-reproduction">Accurate on-disk reproduction</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="cache-fuzzer.html"
                          title="previous chapter">Cache Fuzzer</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="fuzzer.html"
                          title="next chapter">Aggregation and Window Fuzzer</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/develop/testing/expression-fuzzer.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="fuzzer.html" title="Aggregation and Window Fuzzer"
             >next</a> |</li>
        <li class="right" >
          <a href="cache-fuzzer.html" title="Cache Fuzzer"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Velox  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../develop.html" >Developer Guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../testing.html" >Testing Tools</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Expression Fuzzer</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright TBD.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>